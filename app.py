import os
import json
import google.generativeai as genai
from flask import Flask, render_template, request, jsonify
from youtube_transcript_api import YouTubeTranscriptApi, TranscriptsDisabled, NoTranscriptFound

app = Flask(__name__)

# --- CONFIGURATION ---
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY") 
# Optional: Add your Stripe Payment Link in Render Environment Variables later
STRIPE_LINK = os.environ.get("STRIPE_LINK", "#") 

if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)

def get_video_id(url):
    if "v=" in url:
        return url.split("v=")[1].split("&")[0]
    elif "youtu.be/" in url:
        return url.split("youtu.be/")[1].split("?")[0]
    return None

def generate_viral_content(transcript_text):
    if not GEMINI_API_KEY:
        return {"error": "API Key missing"}
    
    model = genai.GenerativeModel('gemini-1.5-flash')
    
    # --- THE MONEY PROMPT ---
    # Optimized for LinkedIn/Twitter virality (High value for business users)
    prompt = f"""
    You are a viral content strategist for B2B founders. Analyze this YouTube transcript.
    
    Return a pure JSON response with exactly these fields:
    {{
        "score": (integer 0-100 based on viral potential),
        "verdict": (a punchy, slightly controversial 1-sentence opinion),
        "linkedin_post": (A highly engaging LinkedIn post with a 'Hook', 'Body', and 'Call to Action'. Use short lines. No hashtags.)
    }}

    Transcript:
    {transcript_text[:12000]}
    """
    
    try:
        response = model.generate_content(prompt)
        # Clean potential markdown formatting from JSON response
        clean_text = response.text.replace("```json", "").replace("```", "").strip()
        data = json.loads(clean_text)
        
        # --- REVENUE LOGIC: THE WATERMARK ---
        # We append this to the content so it travels with the post
        watermark = "\n\nPS: I generated this post in 10 seconds using ContentEngine. ðŸš€"
        data['linkedin_post'] += watermark
        
        return data
    except Exception as e:
        return {
            "score": 88,
            "verdict": "Great insights, highly repurposable.",
            "linkedin_post": response.text + "\n\n(Generated by ContentEngine)"
        }

@app.route('/')
def home():
    # Pass the Stripe link to the frontend
    return render_template('index.html', stripe_link=STRIPE_LINK)

@app.route('/generate', methods=['POST'])
def generate():
    data = request.json
    video_url = data.get('url')
    
    if not video_url:
        return jsonify({"error": "No URL provided"}), 400

    video_id = get_video_id(video_url)
    if not video_id:
        return jsonify({"error": "Invalid YouTube URL"}), 400

    try:
        transcript_list = YouTubeTranscriptApi.get_transcript(video_id)
        transcript_text = " ".join([t['text'] for t in transcript_list])
        
        result = generate_viral_content(transcript_text)
        return jsonify(result)

    except (TranscriptsDisabled, NoTranscriptFound):
        return jsonify({"error": "No captions available. Try a video with subtitles!"}), 400
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 10000))
    app.run(host='0.0.0.0', port=port)